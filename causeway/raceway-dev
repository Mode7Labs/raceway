#!/usr/bin/env bash

set -euo pipefail

if [[ "${TRACE:-}" == "1" ]]; then
  set -x
fi

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${SCRIPT_DIR}"

# â”€â”€â”€ Styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESC=$'\033'
RESET="${ESC}[0m"
BOLD="${ESC}[1m"
DIM="${ESC}[2m"

CYAN="${ESC}[36m"
GREEN="${ESC}[32m"
YELLOW="${ESC}[33m"
MAGENTA="${ESC}[35m"
RED="${ESC}[31m"

ICON_BUILD="ðŸ› ï¸ "
ICON_SERVER="ðŸš€"
ICON_TUI="ðŸŽ¨"
ICON_WEB="ðŸŒ"
ICON_SEED="ðŸŒ±"
ICON_DEMO="ðŸ’°"
ICON_DISTRIBUTED="ðŸŒ"
ICON_EXIT="ðŸ‘‹"
ICON_TEST="âœ…"

# â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print_header() {
  printf "\n${BOLD}${MAGENTA}Raceway Dev Menu${RESET}\n"
  printf "${DIM}Workspace:${RESET} %s\n\n" "${SCRIPT_DIR}"
}

require_tool() {
  local tool=$1
  if ! command -v "${tool}" >/dev/null 2>&1; then
    printf "${RED}Error:${RESET} required tool '${tool}' not found in PATH.\n"
    exit 1
  fi
}

run_step() {
  local title=$1
  local command=$2
  local working_dir=${3:-"${SCRIPT_DIR}"}

  printf "${CYAN}${BOLD}%s${RESET}\n" "${title}"
  printf "${DIM}â†’ ${command}${RESET}\n\n"

  (
    cd "${working_dir}"
    eval "${command}"
  )
}

# â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
action_build() {
  require_tool cargo
  run_step "${ICON_BUILD} Building (cargo build)" "cargo build"
}

action_server() {
  require_tool cargo
  run_step "${ICON_SERVER} Starting server (cargo run --release -- serve)" \
    "cargo run --release -- serve"
}

action_tui() {
  require_tool cargo
  run_step "${ICON_TUI} Launching TUI (cargo run --release -- tui)" \
    "cargo run --release -- tui"
}

action_web() {
  # Prefer pnpm, then npm
  local pkg_manager
  if command -v pnpm >/dev/null 2>&1; then
    pkg_manager="pnpm"
  else
    require_tool npm
    pkg_manager="npm"
  fi

  local command
  if [[ "${pkg_manager}" == "pnpm" ]]; then
    command="pnpm run dev -- --port 3005"
  else
    command="npm run dev -- -- --port 3005"
  fi

  run_step "${ICON_WEB} Starting Web UI (${pkg_manager} dev --port 3005)" \
    "${command}" \
    "${SCRIPT_DIR}/web"
}

action_tests() {
  require_tool cargo
  run_step "${ICON_TEST} Graph unit tests (cargo test -p raceway-core graph::tests)" \
    "cargo test -p raceway-core graph::tests"
  run_step "${ICON_TEST} Integration tests (cargo test -p raceway-test)" \
    "cargo test -p raceway-test"

  # SDK tests
  if command -v npm >/dev/null 2>&1; then
    run_step "${ICON_TEST} TypeScript SDK tests (npm test)" \
      "npm test" \
      "${SCRIPT_DIR}/sdks/typescript"
  fi

  if command -v go >/dev/null 2>&1; then
    run_step "${ICON_TEST} Go SDK tests (go test ./...)" \
      "go test ./..." \
      "${SCRIPT_DIR}/sdks/go"
  fi

  if command -v python3 >/dev/null 2>&1; then
    # Check if pytest is available as a module
    if python3 -c "import pytest" 2>/dev/null; then
      run_step "${ICON_TEST} Python SDK tests (python3 -m pytest)" \
        "python3 -m pytest tests/test_trace_context.py -v" \
        "${SCRIPT_DIR}/sdks/python"
    fi
  fi

  if command -v cargo >/dev/null 2>&1; then
    run_step "${ICON_TEST} Rust SDK tests (cargo test)" \
      "cargo test" \
      "${SCRIPT_DIR}/sdks/rust"
  fi
}

action_seed() {
  # Prefer pnpm, then npx
  local pkg_manager
  if command -v pnpm >/dev/null 2>&1; then
    pkg_manager="pnpm exec ts-node"
  else
    require_tool npx
    pkg_manager="npx ts-node"
  fi

  run_step "${ICON_SEED} Seeding database (${pkg_manager} scripts/seed-database.ts)" \
    "${pkg_manager} scripts/seed-database.ts" \
    "${SCRIPT_DIR}"
}

action_demo_typescript() {
  require_tool node
  run_step "${ICON_DEMO} Starting TypeScript demo (node index.js on port 3050)" \
    "PORT=3050 node index.js" \
    "${SCRIPT_DIR}/examples/express-banking"
}

action_demo_rust() {
  require_tool cargo
  run_step "${ICON_DEMO} Starting Rust demo (cargo run on port 3051)" \
    "cargo run --release" \
    "${SCRIPT_DIR}/examples/rust-banking"
}

action_demo_go() {
  require_tool go
  run_step "${ICON_DEMO} Starting Go demo (go run main.go on port 3052)" \
    "PORT=3052 go run main.go" \
    "${SCRIPT_DIR}/examples/go-banking"
}

action_demo_python() {
  require_tool python3
  run_step "${ICON_DEMO} Starting Python demo (python app.py on port 3053)" \
    "PORT=3053 python3 app.py" \
    "${SCRIPT_DIR}/examples/python-banking"
}

action_distributed_demo() {
  printf "${CYAN}${BOLD}${ICON_DISTRIBUTED} Distributed Tracing Demo (Phase 1.5)${RESET}\n"
  printf "${DIM}Testing header propagation: TypeScript â†’ Python â†’ Go â†’ Rust${RESET}\n\n"

  run_step "${ICON_DISTRIBUTED} Running distributed demo test suite" \
    "./test.sh" \
    "${SCRIPT_DIR}/examples/distributed"
}

# â”€â”€â”€ Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print_menu() {
  print_header
  cat <<EOF
${BOLD}${CYAN}Core${RESET}
${GREEN}1)${RESET} ${ICON_BUILD} Rebuild core (cargo build)
${GREEN}2)${RESET} ${ICON_SERVER} Start server (cargo run --release -- serve)
${GREEN}3)${RESET} ${ICON_TUI} Launch TUI (cargo run --release -- tui)
${GREEN}4)${RESET} ${ICON_WEB} Start Web UI (Vite on port 3005)
${GREEN}5)${RESET} ${ICON_BUILD} Run tests (core + integration)
${GREEN}6)${RESET} ${ICON_SEED} Seed database (clear & seed test data)

${BOLD}${CYAN}Demo Apps${RESET}
${GREEN}7)${RESET} ${ICON_DEMO} TypeScript Banking (Node.js/Express on port 3050)
${GREEN}8)${RESET} ${ICON_DEMO} Rust Banking (Axum on port 3051)
${GREEN}9)${RESET} ${ICON_DEMO} Go Banking (Gin on port 3052)
${GREEN}10)${RESET} ${ICON_DEMO} Python Banking (Flask on port 3053)

${BOLD}${CYAN}Distributed Tracing${RESET}
${GREEN}11)${RESET} ${ICON_DISTRIBUTED} Phase 1.5 Demo (TS â†’ Py â†’ Go â†’ Rust chain on ports 6001-6004)

${YELLOW}q)${RESET} ${ICON_EXIT} Quit
EOF
  printf "\nSelect an option: "
}

main_loop() {
  while true; do
    print_menu
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_build ;;
      2) action_server ;;
      3) action_tui ;;
      4) action_web ;;
      5) action_tests ;;
      6) action_seed ;;
      7) action_demo_typescript ;;
      8) action_demo_rust ;;
      9) action_demo_go ;;
      10) action_demo_python ;;
      11) action_distributed_demo ;;
      q|Q) printf "${ICON_EXIT} Bye!\n"; exit 0 ;;
      *) printf "${RED}Invalid selection.${RESET} Try again.\n\n" ;;
    esac

    printf "\n${DIM}Press Enter to return to the menu...${RESET}"
    read -r _
    printf "\n"
  done
}

main_loop

#!/usr/bin/env bash

set -euo pipefail

if [[ "${TRACE:-}" == "1" ]]; then
  set -x
fi

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${SCRIPT_DIR}"

# â”€â”€â”€ Styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESC=$'\033'
RESET="${ESC}[0m"
BOLD="${ESC}[1m"
DIM="${ESC}[2m"

CYAN="${ESC}[36m"
GREEN="${ESC}[32m"
YELLOW="${ESC}[33m"
MAGENTA="${ESC}[35m"
RED="${ESC}[31m"
BLUE="${ESC}[34m"

ICON_BUILD="ğŸ› ï¸"
ICON_SERVER="ğŸš€"
ICON_TUI="ğŸ¨"
ICON_WEB="ğŸŒ"
ICON_SEED="ğŸŒ±"
ICON_DEMO="ğŸ’°"
ICON_DISTRIBUTED="ğŸŒ"
ICON_EXIT="ğŸ‘‹"
ICON_TEST="âœ…"
ICON_SDK="ğŸ“¦"
ICON_DATABASE="ğŸ—„ï¸"
ICON_UTILITIES="ğŸ§°"
ICON_BACK="â¬…ï¸"
ICON_FORMAT="âœ¨"
ICON_CLEAN="ğŸ§¹"
ICON_LOGS="ğŸ“‹"

# â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
print_header() {
  clear
  printf "\n${BOLD}${MAGENTA}Raceway Dev Menu${RESET}\n"
  printf "${DIM}Workspace:${RESET} %s\n\n" "${SCRIPT_DIR}"
}

require_tool() {
  local tool=$1
  if ! command -v "${tool}" >/dev/null 2>&1; then
    printf "${RED}Error:${RESET} required tool '${tool}' not found in PATH.\n"
    exit 1
  fi
}

run_step() {
  local title=$1
  local command=$2
  local working_dir=${3:-"${SCRIPT_DIR}"}

  printf "${CYAN}${BOLD}%s${RESET}\n" "${title}"
  printf "${DIM}â†’ ${command}${RESET}\n\n"

  (
    cd "${working_dir}"
    eval "${command}"
  )
}

pause() {
  printf "\n${DIM}Press Enter to continue...${RESET}"
  read -r _
  printf "\n"
}

kill_processes_on_port() {
  local port=$1

  if command -v lsof >/dev/null 2>&1; then
    local pids
    pids=$(lsof -t -i :"${port}" 2>/dev/null | sort -u)
    if [[ -n "${pids}" ]]; then
      printf "${DIM}Reclaiming port %s (PIDs: %s)...${RESET}\n" "${port}" "${pids}"
      while read -r pid; do
        [[ -z "${pid}" ]] && continue
        kill "${pid}" >/dev/null 2>&1 || true
      done <<<"${pids}"
      printf "${GREEN}âœ“ Port %s is now free${RESET}\n" "${port}"
    else
      printf "${DIM}No active process on port %s${RESET}\n" "${port}"
    fi
  elif command -v fuser >/dev/null 2>&1; then
    if fuser -k "${port}"/tcp >/dev/null 2>&1; then
      printf "${GREEN}âœ“ Freed port %s${RESET}\n" "${port}"
    else
      printf "${DIM}No active process on port %s${RESET}\n" "${port}"
    fi
  else
    printf "${YELLOW}Warning:${RESET} unable to reclaim port %s (install lsof or fuser)\n" "${port}"
  fi
}

ensure_raceway_binary() {
  if [[ -x "${SCRIPT_DIR}/target/release/raceway" ]]; then
    return 0
  fi

  printf "${CYAN}${BOLD}Building Raceway binary (release)${RESET}\n"
  require_tool cargo
  (cd "${SCRIPT_DIR}" && cargo build --release -p raceway)
}

# â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Core Development
action_start_dev_env() {
  printf "${CYAN}${BOLD}${ICON_SERVER} Starting Development Environment${RESET}\n"
  printf "${DIM}This will start the server and web UI${RESET}\n\n"

  ensure_raceway_binary

  # Kill any existing raceway processes
  printf "${YELLOW}Stopping any existing Raceway server instances...${RESET}\n"
  pkill -f "raceway serve" 2>/dev/null || true

  # Kill processes on ports
  kill_processes_on_port 8080
  kill_processes_on_port 3005

  # Small delay to ensure processes are fully stopped
  sleep 1

  printf "${GREEN}Starting Raceway server...${RESET}\n"
  "${SCRIPT_DIR}/target/release/raceway" serve &
  SERVER_PID=$!

  sleep 2

  # Start web UI in background
  local pkg_manager
  if command -v pnpm >/dev/null 2>&1; then
    pkg_manager="pnpm"
  else
    require_tool npm
    pkg_manager="npm"
  fi

  printf "${GREEN}Starting Web UI (${pkg_manager})...${RESET}\n"
  (
    cd "${SCRIPT_DIR}/web"
    if [[ "${pkg_manager}" == "pnpm" ]]; then
      pnpm run dev -- --host 127.0.0.1 --port 3005 &
    else
      npm run dev -- --host 127.0.0.1 --port 3005 &
    fi
  )
  WEB_PID=$!

  printf "\n${GREEN}${BOLD}âœ“ Development environment started!${RESET}\n"
  printf "${DIM}Server PID: ${SERVER_PID}${RESET}\n"
  printf "${DIM}Web UI PID: ${WEB_PID}${RESET}\n"
  printf "${DIM}Access at: http://localhost:3005${RESET}\n"
  printf "\n${YELLOW}Press Ctrl+C to stop both processes${RESET}\n"

  # Wait for both processes
  wait
}

action_build() {
  require_tool cargo
  run_step "${ICON_BUILD} Building core" "cargo build"
}

# Run a test and show traffic light result
run_test_suite() {
  local name="$1"
  local command="$2"
  local dir="${3:-.}"

  printf "  %-50s " "$name"

  local output
  local exit_code

  if [[ "$dir" != "." ]]; then
    set +e
    output=$(cd "$dir" && bash -c "$command" </dev/null 2>&1)
    exit_code=$?
  else
    set +e
    output=$(bash -c "$command" </dev/null 2>&1)
    exit_code=$?
  fi

  # Parse test results (keep set +e active during parsing to prevent grep failures from exiting)
  local passed=0
  local failed=0
  local total=0

  # Rust/Cargo tests
  if echo "$output" | grep -q "test result:"; then
    passed=$(echo "$output" | grep "test result:" | sed -n 's/.*ok\. \([0-9]*\) passed.*/\1/p' | head -1)
    failed=$(echo "$output" | grep "test result:" | sed -n 's/.*\([0-9]*\) failed.*/\1/p' | head -1)
    total=$((passed + failed))
  # Jest/TypeScript tests
  elif echo "$output" | grep -q "Test Suites:"; then
    passed=$(echo "$output" | grep "Tests:" | sed -n 's/.*Tests:[ ]*\([0-9][0-9]*\) passed.*/\1/p' | head -1)
    failed=$(echo "$output" | grep "Tests:" | sed -n 's/.*\([0-9][0-9]*\) failed.*/\1/p' | head -1)
    [[ -z "$passed" ]] && passed=0
    [[ -z "$failed" ]] && failed=0
    total=$((passed + failed))
  # Go tests
  elif echo "$output" | grep -q "^ok"; then
    passed=1
    failed=0
    total=1
  elif echo "$output" | grep -q "^FAIL"; then
    passed=0
    failed=1
    total=1
  # pytest (Python) - must be last as "passed" is generic
  elif echo "$output" | grep -q "passed.*in.*s"; then
    # pytest format: "80 passed in 0.04s" or "80 passed, 1 failed in 0.04s"
    passed=$(echo "$output" | grep -o '[0-9]\+ passed' | grep -o '[0-9]\+' | head -1)
    failed=$(echo "$output" | grep -o '[0-9]\+ failed' | grep -o '[0-9]\+' | head -1)
    [[ -z "$passed" ]] && passed=0
    [[ -z "$failed" ]] && failed=0
    total=$((passed + failed))
  fi

  # Re-enable exit on error after parsing
  set -e

  # Display result
  if [[ $exit_code -eq 0 && $failed -eq 0 ]]; then
    printf "${GREEN}âœ“${RESET} ${DIM}($passed passed)${RESET}\n"
  else
    printf "${RED}âœ—${RESET} ${DIM}($passed passed, $failed failed)${RESET}\n"
    printf "\n${YELLOW}${BOLD}Failed Test Output:${RESET}\n"
    echo "$output" | tail -30
    printf "\n"
  fi

  return 0
}

action_tests_all() {
  printf "${CYAN}${BOLD}${ICON_TEST} Test Suite${RESET}\n\n"

  printf "${BOLD}Core Tests${RESET}\n"
  run_test_suite "Graph tests" "cargo test -p raceway-core graph::tests --quiet"
  run_test_suite "Integration tests (API)" "cargo test -p raceway-test --test api --quiet"
  run_test_suite "Integration tests (Distributed)" "cargo test -p raceway-test --test distributed --quiet"
  run_test_suite "Integration tests (E2E)" "cargo test -p raceway-test --test e2e --quiet"
  run_test_suite "Storage backend (memory)" "cargo test -p raceway-core memory_backend_distributed_insights --quiet"

  if [[ -n "${RACEWAY_TEST_PG_URL:-}" ]]; then
    run_test_suite "Storage backend (Postgres)" "RACEWAY_TEST_PG_URL=\"${RACEWAY_TEST_PG_URL}\" cargo test -p raceway-core postgres_backend_distributed_insights --quiet"
  else
    printf "${YELLOW}Storage backend (Postgres)${RESET} ${DIM}- skipped (set RACEWAY_TEST_PG_URL)${RESET}\n"
  fi

  printf "\n${BOLD}SDK Tests${RESET}\n"

  if command -v npm >/dev/null 2>&1; then
    run_test_suite "TypeScript SDK" "./node_modules/.bin/jest --watchAll=false --forceExit --silent" "${SCRIPT_DIR}/sdks/typescript"
    run_test_suite "Babel Plugin" "npm test --silent" "${SCRIPT_DIR}/sdks/typescript/babel-plugin"
  fi

  if command -v go >/dev/null 2>&1; then
    run_test_suite "Go SDK" "go test ./... -v" "${SCRIPT_DIR}/sdks/go"
  fi

  if command -v python3 >/dev/null 2>&1 && python3 -c "import pytest" 2>/dev/null; then
    run_test_suite "Python SDK" "python3 -m pytest -q" "${SCRIPT_DIR}/sdks/python"
  fi

  if command -v cargo >/dev/null 2>&1; then
    run_test_suite "Rust SDK" "cargo test --quiet" "${SCRIPT_DIR}/sdks/rust"
  fi

  printf "\n"
}

action_tests_core() {
  require_tool cargo
  run_step "${ICON_TEST} Core graph tests" \
    "cargo test -p raceway-core graph::tests"
  run_step "${ICON_TEST} Integration tests" \
    "cargo test -p raceway-test"
  run_step "${ICON_TEST} Storage backend (memory)" \
    "cargo test -p raceway-core memory_backend_distributed_insights"

  if [[ -n "${RACEWAY_TEST_PG_URL:-}" ]]; then
    run_step "${ICON_TEST} Storage backend (Postgres)" \
      "RACEWAY_TEST_PG_URL=\"${RACEWAY_TEST_PG_URL}\" cargo test -p raceway-core postgres_backend_distributed_insights"
  else
    printf "${YELLOW}Skipping Postgres storage backend tests (set RACEWAY_TEST_PG_URL)${RESET}\n"
  fi
}

action_tests_sdk_all() {
  printf "${CYAN}${BOLD}${ICON_SDK} Running All SDK Tests${RESET}\n\n"

  if command -v npm >/dev/null 2>&1; then
    run_step "${ICON_TEST} TypeScript SDK tests" \
      "./node_modules/.bin/jest --watchAll=false --forceExit" \
      "${SCRIPT_DIR}/sdks/typescript"

    run_step "${ICON_TEST} Babel Plugin tests" \
      "npm test" \
      "${SCRIPT_DIR}/sdks/typescript/babel-plugin"
  fi

  if command -v go >/dev/null 2>&1; then
    run_step "${ICON_TEST} Go SDK tests" \
      "go test ./..." \
      "${SCRIPT_DIR}/sdks/go"
  fi

  if command -v python3 >/dev/null 2>&1 && python3 -c "import pytest" 2>/dev/null; then
    run_step "${ICON_TEST} Python SDK tests" \
      "python3 -m pytest -v" \
      "${SCRIPT_DIR}/sdks/python"
  fi

  if command -v cargo >/dev/null 2>&1; then
    run_step "${ICON_TEST} Rust SDK tests" \
      "cargo test" \
      "${SCRIPT_DIR}/sdks/rust"
  fi
}

action_tests_storage_backends() {
  require_tool cargo
  run_step "${ICON_TEST} Storage backend (memory)" \
    "cargo test -p raceway-core memory_backend_distributed_insights"

  if [[ -n "${RACEWAY_TEST_PG_URL:-}" ]]; then
    run_step "${ICON_TEST} Storage backend (Postgres)" \
      "RACEWAY_TEST_PG_URL=\"${RACEWAY_TEST_PG_URL}\" cargo test -p raceway-core postgres_backend_distributed_insights"
  else
    printf "${YELLOW}Skipping Postgres storage backend tests (set RACEWAY_TEST_PG_URL)${RESET}\n"
  fi
}

action_test_sdk_typescript() {
  require_tool npm
  run_step "${ICON_TEST} TypeScript SDK tests" \
    "./node_modules/.bin/jest --watchAll=false --forceExit" \
    "${SCRIPT_DIR}/sdks/typescript"

  run_step "${ICON_TEST} Babel Plugin tests" \
    "npm test" \
    "${SCRIPT_DIR}/sdks/typescript/babel-plugin"
}

action_test_babel_plugin() {
  require_tool npm
  run_step "${ICON_TEST} Babel Plugin tests" \
    "npm test" \
    "${SCRIPT_DIR}/sdks/typescript/babel-plugin"
}

action_test_sdk_python() {
  require_tool python3
  if ! python3 -c "import pytest" 2>/dev/null; then
    printf "${RED}Error:${RESET} pytest not installed. Run: pip install pytest\n"
    return 1
  fi
  run_step "${ICON_TEST} Python SDK tests (80 tests)" \
    "python3 -m pytest -v" \
    "${SCRIPT_DIR}/sdks/python"
}

action_test_sdk_go() {
  require_tool go
  run_step "${ICON_TEST} Go SDK tests" \
    "go test ./..." \
    "${SCRIPT_DIR}/sdks/go"
}

action_test_sdk_rust() {
  require_tool cargo
  run_step "${ICON_TEST} Rust SDK tests" \
    "cargo test" \
    "${SCRIPT_DIR}/sdks/rust"
}

# Demo Apps
action_server() {
  ensure_raceway_binary

  # Kill any existing raceway processes
  printf "${YELLOW}Stopping any existing Raceway server instances...${RESET}\n"
  pkill -f "raceway serve" 2>/dev/null || true

  printf "${DIM}Cleaning up port 8080...${RESET}\n"
  kill_processes_on_port 8080 || true

  # Small delay to ensure processes are fully stopped
  sleep 1

  printf "\n${CYAN}${BOLD}${ICON_SERVER} Starting server${RESET}\n"
  printf "${DIM}â†’ ${SCRIPT_DIR}/target/release/raceway serve &${RESET}\n\n"

  # Start server in background
  "${SCRIPT_DIR}/target/release/raceway" serve > /tmp/raceway-server.log 2>&1 &
  SERVER_PID=$!

  sleep 2

  # Check if server started successfully
  if ps -p $SERVER_PID > /dev/null 2>&1; then
    printf "${GREEN}${BOLD}âœ“ Server started successfully!${RESET}\n"
    printf "${DIM}PID: ${SERVER_PID}${RESET}\n"
    printf "${DIM}Listening on: http://localhost:8080${RESET}\n"
    printf "${DIM}Logs: /tmp/raceway-server.log${RESET}\n\n"
    printf "${YELLOW}To view logs: tail -f /tmp/raceway-server.log${RESET}\n"
    printf "${YELLOW}To stop: pkill -f 'raceway serve'${RESET}\n"
  else
    printf "${RED}${BOLD}âœ— Server failed to start${RESET}\n"
    printf "${YELLOW}Check logs: tail /tmp/raceway-server.log${RESET}\n"
    return 1
  fi
}

action_tui() {
  ensure_raceway_binary
  run_step "${ICON_TUI} Launching TUI" \
    "${SCRIPT_DIR}/target/release/raceway tui"
}

action_web() {
  printf "${DIM}Cleaning up port 3005...${RESET}\n"
  kill_processes_on_port 3005 || true

  # Small delay to ensure process is fully stopped
  sleep 1

  local pkg_manager
  if command -v pnpm >/dev/null 2>&1; then
    pkg_manager="pnpm"
  else
    require_tool npm
    pkg_manager="npm"
  fi

  local log_file="${SCRIPT_DIR}/web/.devserver.log"

  printf "\n${CYAN}${BOLD}${ICON_WEB} Starting Web UI${RESET}\n"
  printf "${DIM}â†’ cd ${SCRIPT_DIR}/web && ${pkg_manager} run dev -- --host 127.0.0.1 --port 3005 &${RESET}\n\n"

  # Start web UI in background
  (
    cd "${SCRIPT_DIR}/web"
    if [[ "${pkg_manager}" == "pnpm" ]]; then
      pnpm run dev -- --host 127.0.0.1 --port 3005 >"${log_file}" 2>&1 &
    else
      npm run dev -- --host 127.0.0.1 --port 3005 >"${log_file}" 2>&1 &
    fi
    WEB_PID=$!
    echo "${WEB_PID}" > "${SCRIPT_DIR}/web/.devserver.pid"
  )

  sleep 2

  # Check if web UI started successfully
  if command -v lsof >/dev/null 2>&1; then
    if lsof -i :3005 >/dev/null 2>&1; then
      printf "${GREEN}${BOLD}âœ“ Web UI started successfully!${RESET}\n"
      if [[ -f "${SCRIPT_DIR}/web/.devserver.pid" ]]; then
        local saved_pid
        saved_pid=$(cat "${SCRIPT_DIR}/web/.devserver.pid")
        printf "${DIM}PID: ${saved_pid}${RESET}\n"
      fi
      printf "${DIM}Listening on: http://localhost:3005${RESET}\n"
      printf "${DIM}Logs: ${log_file}${RESET}\n\n"
      printf "${YELLOW}To view logs: tail -f ${log_file}${RESET}\n"
      printf "${YELLOW}To stop: pkill -f 'vite'${RESET}\n"
    else
      printf "${RED}${BOLD}âœ— Web UI failed to start${RESET}\n"
      printf "${YELLOW}Check logs: tail ${log_file}${RESET}\n"
      if [[ -f "${log_file}" ]]; then
        printf "\n${YELLOW}${BOLD}Last 20 lines of log:${RESET}\n"
        tail -n 20 "${log_file}" 2>/dev/null || true
      fi
      return 1
    fi
  else
    printf "${YELLOW}âš ï¸  Unable to verify Web UI status (lsof not installed).${RESET}\n"
    printf "${DIM}Check ${log_file} for startup output.${RESET}\n"
  fi
}

action_restart_server() {
  action_server
}

action_restart_web() {
  action_web
}

action_demo_typescript() {
  require_tool node
  run_step "${ICON_DEMO} TypeScript Banking Demo (Express on port 3050)" \
    "PORT=3050 node index.js" \
    "${SCRIPT_DIR}/examples/express-banking"
}

action_demo_rust() {
  require_tool cargo
  run_step "${ICON_DEMO} Rust Banking Demo (Axum on port 3051)" \
    "cargo run --release" \
    "${SCRIPT_DIR}/examples/rust-banking"
}

action_demo_go() {
  require_tool go
  run_step "${ICON_DEMO} Go Banking Demo (Gin on port 3052)" \
    "PORT=3052 go run main.go" \
    "${SCRIPT_DIR}/examples/go-banking"
}

action_demo_python() {
  require_tool python3
  run_step "${ICON_DEMO} Python Banking Demo (Flask on port 3053)" \
    "PORT=3053 python3 app.py" \
    "${SCRIPT_DIR}/examples/python-banking"
}

# Distributed Tracing
action_distributed_full_chain() {
  printf "${CYAN}${BOLD}${ICON_DISTRIBUTED} Full Chain Test${RESET}\n"
  printf "${DIM}Single trace through: TypeScript â†’ Python â†’ Go â†’ Rust${RESET}\n\n"

  run_step "${ICON_DISTRIBUTED} Running full-chain.sh" \
    "./patterns/full-chain.sh" \
    "${SCRIPT_DIR}/examples/distributed"
}

action_distributed_linear() {
  printf "${CYAN}${BOLD}${ICON_DISTRIBUTED} Linear Pattern Test${RESET}\n"
  printf "${DIM}Separate requests to each service${RESET}\n\n"

  run_step "${ICON_DISTRIBUTED} Running linear.sh" \
    "./patterns/linear.sh" \
    "${SCRIPT_DIR}/examples/distributed"
}

action_distributed_test_suite() {
  printf "${CYAN}${BOLD}${ICON_DISTRIBUTED} Full Test Suite${RESET}\n"
  printf "${DIM}Comprehensive distributed tracing tests${RESET}\n\n"

  run_step "${ICON_DISTRIBUTED} Running test.sh" \
    "./test.sh" \
    "${SCRIPT_DIR}/examples/distributed"
}

action_distributed_start_services() {
  printf "${CYAN}${BOLD}${ICON_DISTRIBUTED} Starting All Distributed Services${RESET}\n"
  printf "${DIM}Ports: TypeScript(6001), Python(6002), Go(6003), Rust(6004)${RESET}\n\n"

  if ! cd "${SCRIPT_DIR}/examples/distributed" 2>/dev/null; then
    printf "${RED}Error: Could not find examples/distributed directory${RESET}\n"
    return 1
  fi

  # Kill any existing services first
  printf "${DIM}Cleaning up any existing services...${RESET}\n"
  kill_processes_on_port 6001 || true
  kill_processes_on_port 6002 || true
  kill_processes_on_port 6003 || true
  kill_processes_on_port 6004 || true
  printf "\n"

  # TypeScript service
  printf "${GREEN}Starting TypeScript service (port 6001)...${RESET}\n"
  (cd services/typescript-service && npm start > /tmp/raceway-ts.log 2>&1) &
  TS_PID=$!

  # Python service
  printf "${GREEN}Starting Python service (port 6002)...${RESET}\n"
  (cd services/python-service && python3 server.py > /tmp/raceway-py.log 2>&1) &
  PY_PID=$!

  # Go service
  printf "${GREEN}Starting Go service (port 6003)...${RESET}\n"
  (cd services/go-service && go run main.go > /tmp/raceway-go.log 2>&1) &
  GO_PID=$!

  # Rust service
  printf "${GREEN}Starting Rust service (port 6004)...${RESET}\n"
  (cd services/rust-service && cargo run --release > /tmp/raceway-rust.log 2>&1) &
  RUST_PID=$!

  # Save PIDs to file for stop action
  echo "${TS_PID} ${PY_PID} ${GO_PID} ${RUST_PID}" > /tmp/raceway-distributed-pids

  printf "\n${YELLOW}Waiting for services to initialize...${RESET}\n"
  sleep 3

  # Check if services are responding
  printf "\n${CYAN}Checking service health...${RESET}\n"

  SERVICES_OK=1
  for port in 6001 6002 6003 6004; do
    if curl -s -f "http://localhost:${port}/health" > /dev/null 2>&1; then
      printf "${GREEN}âœ“ Service on port ${port} is healthy${RESET}\n"
    else
      printf "${RED}âœ— Service on port ${port} is not responding${RESET}\n"
      SERVICES_OK=0
    fi
  done

  if [[ $SERVICES_OK -eq 1 ]]; then
    printf "\n${GREEN}${BOLD}âœ“ All services started successfully!${RESET}\n"
  else
    printf "\n${YELLOW}âš ï¸  Some services may need more time to start${RESET}\n"
    printf "${DIM}Check logs: /tmp/raceway-{ts,py,go,rust}.log${RESET}\n"
  fi

  printf "\n${DIM}TypeScript PID: ${TS_PID} (log: /tmp/raceway-ts.log)${RESET}\n"
  printf "${DIM}Python PID: ${PY_PID} (log: /tmp/raceway-py.log)${RESET}\n"
  printf "${DIM}Go PID: ${GO_PID} (log: /tmp/raceway-go.log)${RESET}\n"
  printf "${DIM}Rust PID: ${RUST_PID} (log: /tmp/raceway-rust.log)${RESET}\n"
  printf "\n${CYAN}${BOLD}Services running in background${RESET}\n"
  printf "${DIM}Use 'Stop All Services' option to stop them${RESET}\n"
}

action_distributed_stop_services() {
  printf "${YELLOW}Stopping distributed services...${RESET}\n\n"

  # First try to kill by PIDs
  if [[ -f /tmp/raceway-distributed-pids ]]; then
    if read -r TS_PID PY_PID GO_PID RUST_PID < /tmp/raceway-distributed-pids 2>/dev/null; then
      # Send SIGTERM for graceful shutdown (allows event flushing)
      printf "${DIM}Sending SIGTERM to services for graceful shutdown...${RESET}\n"

      [[ -n "${TS_PID:-}" ]] && kill -TERM "${TS_PID}" 2>/dev/null || true
      [[ -n "${PY_PID:-}" ]] && kill -TERM "${PY_PID}" 2>/dev/null || true
      [[ -n "${GO_PID:-}" ]] && kill -TERM "${GO_PID}" 2>/dev/null || true
      [[ -n "${RUST_PID:-}" ]] && kill -TERM "${RUST_PID}" 2>/dev/null || true

      sleep 2

      # Force kill if still running
      printf "${DIM}Force killing any remaining processes...${RESET}\n"
      [[ -n "${TS_PID:-}" ]] && kill -9 "${TS_PID}" 2>/dev/null || true
      [[ -n "${PY_PID:-}" ]] && kill -9 "${PY_PID}" 2>/dev/null || true
      [[ -n "${GO_PID:-}" ]] && kill -9 "${GO_PID}" 2>/dev/null || true
      [[ -n "${RUST_PID:-}" ]] && kill -9 "${RUST_PID}" 2>/dev/null || true
    fi

    rm -f /tmp/raceway-distributed-pids
  fi

  # Also kill by port to ensure cleanup
  printf "${DIM}Cleaning up ports...${RESET}\n"
  kill_processes_on_port 6001 || true
  kill_processes_on_port 6002 || true
  kill_processes_on_port 6003 || true
  kill_processes_on_port 6004 || true

  printf "\n${GREEN}âœ“ All services stopped${RESET}\n"
}

# SDK Tools
action_sdk_build_all() {
  printf "${CYAN}${BOLD}${ICON_SDK} Building All SDKs${RESET}\n\n"

  if command -v npm >/dev/null 2>&1; then
    run_step "${ICON_SDK} Building TypeScript SDK" \
      "npm run build" \
      "${SCRIPT_DIR}/sdks/typescript"

    run_step "${ICON_SDK} Building Babel Plugin" \
      "npm run build" \
      "${SCRIPT_DIR}/sdks/typescript/babel-plugin"
  fi

  if command -v cargo >/dev/null 2>&1; then
    run_step "${ICON_SDK} Building Rust SDK" \
      "cargo build" \
      "${SCRIPT_DIR}/sdks/rust"
  fi

  printf "${GREEN}${BOLD}âœ“ SDK builds complete${RESET}\n"
}

# Database
action_seed() {
  local pkg_manager
  if command -v pnpm >/dev/null 2>&1; then
    pkg_manager="pnpm exec ts-node"
  else
    require_tool npx
    pkg_manager="npx ts-node"
  fi

  run_step "${ICON_SEED} Seeding database" \
    "${pkg_manager} scripts/seed-database.ts" \
    "${SCRIPT_DIR}"
}

action_clear_database() {
  printf "${YELLOW}${BOLD}${ICON_DATABASE} Clearing Database${RESET}\n"
  printf "${DIM}This will delete all traces and events${RESET}\n\n"

  # Detect storage backend from config
  local backend="memory"
  local conn_string=""

  if [[ -f "${SCRIPT_DIR}/raceway.toml" ]]; then
    backend=$(grep -A 5 '^\[storage\]' "${SCRIPT_DIR}/raceway.toml" | grep '^backend' | cut -d'"' -f2 | head -1)
    if [[ "$backend" == "postgres" || "$backend" == "supabase" ]]; then
      conn_string=$(grep 'connection_string' "${SCRIPT_DIR}/raceway.toml" | cut -d'"' -f2)
    fi
  fi

  printf "${DIM}Storage backend: ${backend}${RESET}\n\n"

  printf "Are you sure? (y/N): "
  read -r confirm

  if [[ "${confirm}" =~ ^[Yy]$ ]]; then
    case "$backend" in
      "memory")
        printf "${YELLOW}Using in-memory storage - data will be cleared on server restart${RESET}\n"
        printf "${GREEN}âœ“ No action needed for in-memory storage${RESET}\n"
        ;;

      "postgres"|"supabase")
        if [[ -z "$conn_string" ]]; then
          printf "${RED}âœ— No connection string found in raceway.toml${RESET}\n"
          return 1
        fi

        printf "${CYAN}Truncating all tables in PostgreSQL database...${RESET}\n"

        # List of tables to truncate (in correct order due to foreign keys)
        local tables=(
          "cross_trace_index"
          "anomalies"
          "causal_edges"
          "trace_roots"
          "distributed_edges"
          "distributed_spans"
          "events"
          "baseline_metrics"
        )

        # Build truncate command
        local truncate_cmd="TRUNCATE TABLE ${tables[*]} CASCADE;"

        # Execute via psql
        if command -v psql >/dev/null 2>&1; then
          echo "$truncate_cmd" | psql "$conn_string" -q 2>/dev/null
          if [[ $? -eq 0 ]]; then
            printf "${GREEN}âœ“ All tables cleared successfully${RESET}\n"
          else
            printf "${RED}âœ— Failed to clear tables${RESET}\n"
            return 1
          fi
        else
          printf "${RED}âœ— psql command not found. Install PostgreSQL client tools.${RESET}\n"
          return 1
        fi
        ;;

      *)
        printf "${RED}âœ— Unknown storage backend: ${backend}${RESET}\n"
        return 1
        ;;
    esac
  else
    printf "${DIM}Cancelled${RESET}\n"
  fi
}

action_database_stats() {
  printf "${CYAN}${BOLD}${ICON_DATABASE} Database Statistics${RESET}\n\n"

  # Detect storage backend from config
  local backend="memory"
  local conn_string=""

  if [[ -f "${SCRIPT_DIR}/raceway.toml" ]]; then
    backend=$(grep -A 5 '^\[storage\]' "${SCRIPT_DIR}/raceway.toml" | grep '^backend' | cut -d'"' -f2 | head -1)
    if [[ "$backend" == "postgres" || "$backend" == "supabase" ]]; then
      conn_string=$(grep 'connection_string' "${SCRIPT_DIR}/raceway.toml" | cut -d'"' -f2)
    fi
  fi

  case "$backend" in
    "memory")
      printf "${YELLOW}Using in-memory storage - stats not available${RESET}\n"
      printf "${DIM}Query the API /status endpoint for runtime stats${RESET}\n"
      ;;

    "postgres"|"supabase")
      if [[ -z "$conn_string" ]]; then
        printf "${RED}âœ— No connection string found in raceway.toml${RESET}\n"
        return 1
      fi

      if ! command -v psql >/dev/null 2>&1; then
        printf "${RED}âœ— psql command not found. Install PostgreSQL client tools.${RESET}\n"
        return 1
      fi

      printf "${GREEN}Events:${RESET} "
      echo "SELECT COUNT(*) FROM events;" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '

      printf "${GREEN}Traces:${RESET} "
      echo "SELECT COUNT(DISTINCT trace_id) FROM events;" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '

      printf "${GREEN}Services:${RESET} "
      echo "SELECT COUNT(DISTINCT metadata->>'service_name') FROM events WHERE metadata->>'service_name' IS NOT NULL;" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '

      printf "${GREEN}Distributed Spans:${RESET} "
      echo "SELECT COUNT(*) FROM distributed_spans;" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '

      printf "${GREEN}Distributed Edges:${RESET} "
      echo "SELECT COUNT(*) FROM distributed_edges;" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '

      printf "\n${GREEN}Database size:${RESET} "
      echo "SELECT pg_size_pretty(pg_database_size(current_database()));" | psql "$conn_string" -t -q 2>/dev/null | tr -d ' '
      ;;

    *)
      printf "${RED}âœ— Unknown storage backend: ${backend}${RESET}\n"
      return 1
      ;;
  esac
}

# Utilities
action_format_code() {
  printf "${CYAN}${BOLD}${ICON_FORMAT} Formatting Code${RESET}\n\n"

  # Rust
  if command -v cargo >/dev/null 2>&1; then
    run_step "${ICON_FORMAT} Formatting Rust code" \
      "cargo fmt --all"
  fi

  # TypeScript/JavaScript
  if command -v npx >/dev/null 2>&1; then
    run_step "${ICON_FORMAT} Formatting TypeScript/JavaScript" \
      "npx prettier --write '**/*.{ts,js,json}' --ignore-path .gitignore" \
      "${SCRIPT_DIR}"
  fi

  printf "${GREEN}${BOLD}âœ“ Code formatting complete${RESET}\n"
}

action_clean_artifacts() {
  printf "${CYAN}${BOLD}${ICON_CLEAN} Cleaning Build Artifacts${RESET}\n\n"

  printf "${YELLOW}This will remove:${RESET}\n"
  printf "  - Rust target/ directory\n"
  printf "  - Node node_modules/ in web/\n"
  printf "  - Build artifacts from examples\n\n"

  printf "Continue? (y/N): "
  read -r confirm

  if [[ "${confirm}" =~ ^[Yy]$ ]]; then
    # Cargo clean
    if command -v cargo >/dev/null 2>&1; then
      run_step "${ICON_CLEAN} Cleaning Rust artifacts" \
        "cargo clean"
    fi

    # Remove web node_modules
    if [[ -d "${SCRIPT_DIR}/web/node_modules" ]]; then
      printf "${DIM}Removing web/node_modules...${RESET}\n"
      rm -rf "${SCRIPT_DIR}/web/node_modules"
    fi

    # Remove example build artifacts
    if [[ -d "${SCRIPT_DIR}/examples/rust-banking/target" ]]; then
      printf "${DIM}Removing examples/rust-banking/target...${RESET}\n"
      rm -rf "${SCRIPT_DIR}/examples/rust-banking/target"
    fi

    printf "${GREEN}${BOLD}âœ“ Cleanup complete${RESET}\n"
  else
    printf "${DIM}Cancelled${RESET}\n"
  fi
}

action_clean_build_artifacts() {
  printf "${CYAN}${BOLD}${ICON_CLEAN} Cleaning All Build Artifacts${RESET}\n\n"

  # Calculate sizes before cleanup
  printf "${BOLD}ğŸ“Š Current disk usage:${RESET}\n"
  du -sh target/ 2>/dev/null && printf "\n" || true
  du -sh sdks/rust/target/ 2>/dev/null || true
  du -sh sdks/python/raceway_sdk.egg-info 2>/dev/null || true
  find . -name "__pycache__" -type d | head -5 | xargs du -sh 2>/dev/null || true

  printf "\n${YELLOW}This will remove:${RESET}\n"
  printf "  - Rust target/ directories (all compiled artifacts)\n"
  printf "  - Python __pycache__/ and *.egg-info/\n"
  printf "  - Node node_modules/ in examples\n"
  printf "  - All example build artifacts\n\n"

  printf "Continue? (y/N): "
  read -r confirm

  if [[ "${confirm}" =~ ^[Yy]$ ]]; then
    printf "\n${CYAN}ğŸ—‘ï¸  Removing Rust artifacts...${RESET}\n"

    # Main target directory
    if [[ -d "target" ]]; then
      rm -rf target/
      printf "${GREEN}  âœ“ Removed target/${RESET}\n"
    fi

    # SDK target
    if [[ -d "sdks/rust/target" ]]; then
      rm -rf sdks/rust/target/
      printf "${GREEN}  âœ“ Removed sdks/rust/target/${RESET}\n"
    fi

    # Example target directories
    find examples -name "target" -type d -exec rm -rf {} + 2>/dev/null || true
    printf "${GREEN}  âœ“ Removed example target/ directories${RESET}\n"

    printf "\n${CYAN}ğŸ—‘ï¸  Removing Python artifacts...${RESET}\n"

    # Python caches and build info
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

    printf "${GREEN}  âœ“ Removed __pycache__/ directories${RESET}\n"
    printf "${GREEN}  âœ“ Removed *.egg-info/ directories${RESET}\n"
    printf "${GREEN}  âœ“ Removed .pyc files${RESET}\n"

    printf "\n${CYAN}ğŸ—‘ï¸  Removing Node artifacts in examples...${RESET}\n"

    # Only remove node_modules in examples, not in web/ or sdks/
    find examples -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
    printf "${GREEN}  âœ“ Removed node_modules/ in examples/${RESET}\n"

    printf "\n${GREEN}${BOLD}âœ… Cleanup complete!${RESET}\n"
    printf "\n${DIM}ğŸ’¡ To rebuild:${RESET}\n"
    printf "${DIM}   Rust:       cargo build --release${RESET}\n"
    printf "${DIM}   Python SDK: cd sdks/python && pip install -e .${RESET}\n"
    printf "${DIM}   Examples:   cd examples/<name> && npm install${RESET}\n"
  else
    printf "${DIM}Cancelled${RESET}\n"
  fi
}

action_view_logs() {
  printf "${CYAN}${BOLD}${ICON_LOGS} View Logs${RESET}\n\n"

  printf "${GREEN}1)${RESET} Tail debug.log\n"
  printf "${GREEN}2)${RESET} Tail raceway-dev.log\n"
  printf "${GREEN}3)${RESET} View both (split screen)\n"
  printf "${YELLOW}b)${RESET} Back\n\n"
  printf "Select: "
  read -r choice

  case "${choice}" in
    1)
      if [[ -f "${SCRIPT_DIR}/debug.log" ]]; then
        tail -f "${SCRIPT_DIR}/debug.log"
      else
        printf "${YELLOW}debug.log not found${RESET}\n"
      fi
      ;;
    2)
      if [[ -f "${SCRIPT_DIR}/raceway-dev.log" ]]; then
        tail -f "${SCRIPT_DIR}/raceway-dev.log"
      else
        printf "${YELLOW}raceway-dev.log not found${RESET}\n"
      fi
      ;;
    3)
      if command -v tmux >/dev/null 2>&1; then
        tmux new-session -d "tail -f ${SCRIPT_DIR}/debug.log" \; \
          split-window -v "tail -f ${SCRIPT_DIR}/raceway-dev.log" \; \
          attach
      else
        printf "${YELLOW}tmux not installed - showing debug.log only${RESET}\n"
        tail -f "${SCRIPT_DIR}/debug.log"
      fi
      ;;
    b|B) return ;;
    *) printf "${RED}Invalid selection${RESET}\n" ;;
  esac
}

# â”€â”€â”€ Menus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

menu_build_test() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_BUILD}  Build & Test${RESET}

${GREEN}1)${RESET} Build core (cargo build)
${GREEN}2)${RESET} Run all tests (core + integration + SDKs)
${GREEN}3)${RESET} Run core tests only
${GREEN}4)${RESET} Run SDK tests only
${GREEN}5)${RESET} Run storage backend tests only

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_build; pause ;;
      2) action_tests_all; pause ;;
      3) action_tests_core; pause ;;
      4) action_tests_sdk_all; pause ;;
      5) action_tests_storage_backends; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

menu_demos() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_DEMO}  Demo Applications${RESET}

${GREEN}1)${RESET} TypeScript Banking (Express on port 3050)
${GREEN}2)${RESET} Rust Banking (Axum on port 3051)
${GREEN}3)${RESET} Go Banking (Gin on port 3052)
${GREEN}4)${RESET} Python Banking (Flask on port 3053)
${GREEN}5)${RESET} Launch TUI to view traces

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_demo_typescript; pause ;;
      2) action_demo_rust; pause ;;
      3) action_demo_go; pause ;;
      4) action_demo_python; pause ;;
      5) action_tui; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

menu_distributed() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_DISTRIBUTED}  Distributed Tracing${RESET}

${GREEN}1)${RESET} Full chain test (TS â†’ Py â†’ Go â†’ Rust in single trace)
${GREEN}2)${RESET} Linear pattern test (separate requests)
${GREEN}3)${RESET} Run full test suite
${GREEN}4)${RESET} Start all services (ports 6001-6004)
${GREEN}5)${RESET} Stop all services

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_distributed_full_chain; pause ;;
      2) action_distributed_linear; pause ;;
      3) action_distributed_test_suite; pause ;;
      4) action_distributed_start_services; pause ;;
      5) action_distributed_stop_services; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

menu_sdks() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_SDK}  SDK Tools${RESET}

${GREEN}1)${RESET} Build all SDKs
${GREEN}2)${RESET} Test all SDKs
${GREEN}3)${RESET} Test TypeScript SDK (includes Babel plugin)
${GREEN}4)${RESET} Test Babel Plugin only
${GREEN}5)${RESET} Test Python SDK
${GREEN}6)${RESET} Test Go SDK
${GREEN}7)${RESET} Test Rust SDK

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_sdk_build_all; pause ;;
      2) action_tests_sdk_all; pause ;;
      3) action_test_sdk_typescript; pause ;;
      4) action_test_babel_plugin; pause ;;
      5) action_test_sdk_python; pause ;;
      6) action_test_sdk_go; pause ;;
      7) action_test_sdk_rust; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

menu_database() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_DATABASE}  Database Tools${RESET}

${GREEN}1)${RESET} Seed database (clear & seed test data)
${GREEN}2)${RESET} Clear database (delete all traces/events)
${GREEN}3)${RESET} View database statistics

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_seed; pause ;;
      2) action_clear_database; pause ;;
      3) action_database_stats; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

menu_utilities() {
  while true; do
    print_header
    cat <<EOF
${BOLD}${CYAN}${ICON_UTILITIES}  Utilities${RESET}

${GREEN}1)${RESET} Format code (cargo fmt, prettier)
${GREEN}2)${RESET} Clean build artifacts
${GREEN}3)${RESET} View logs
${GREEN}4)${RESET} Clean ALL build artifacts (Rust, Python, Node)

${YELLOW}b)${RESET} ${ICON_BACK}  Back to main menu
EOF
    printf "\nSelect: "
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_format_code; pause ;;
      2) action_clean_artifacts; pause ;;
      3) action_view_logs ;;
      4) action_clean_build_artifacts; pause ;;
      b|B) return ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

# â”€â”€â”€ Main Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_main_menu() {
  print_header
  cat <<EOF
${BOLD}${CYAN}Quick Access${RESET}
${GREEN}1)${RESET} ${ICON_SERVER}  Start Dev Environment (Server + Web UI)
${GREEN}2)${RESET} ${ICON_SERVER}  Restart Server (port 8080)
${GREEN}3)${RESET} ${ICON_WEB}  Restart Web UI (port 3005)
${GREEN}4)${RESET} ${ICON_TUI}  Launch TUI

${BOLD}${CYAN}Menus${RESET}
${GREEN}5)${RESET} ${ICON_BUILD}  Build & Test
${GREEN}6)${RESET} ${ICON_DEMO}  Demo Applications
${GREEN}7)${RESET} ${ICON_DISTRIBUTED}  Distributed Tracing
${GREEN}8)${RESET} ${ICON_SDK}  SDK Tools
${GREEN}9)${RESET} ${ICON_DATABASE}  Database
${GREEN}10)${RESET} ${ICON_UTILITIES}  Utilities

${YELLOW}q)${RESET} ${ICON_EXIT}  Quit
EOF
  printf "\nSelect: "
}

main_loop() {
  while true; do
    print_main_menu
    read -r choice
    printf "\n"

    case "${choice}" in
      1) action_start_dev_env ;;
      2) action_restart_server; pause ;;
      3) action_restart_web; pause ;;
      4) action_tui; pause ;;
      5) menu_build_test ;;
      6) menu_demos ;;
      7) menu_distributed ;;
      8) menu_sdks ;;
      9) menu_database ;;
      10) menu_utilities ;;
      q|Q) printf "${ICON_EXIT} Bye!\n"; exit 0 ;;
      *) printf "${RED}Invalid selection${RESET}\n\n"; sleep 1 ;;
    esac
  done
}

main_loop
